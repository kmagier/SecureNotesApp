{% extends "user_notes_dashboard.html"%}

{% block notes %}

{% include "includes/flash_info.html" %}
{% if not private_notes %}

<div class="alert alert-info">
    You don't have any private notes. <a href="{{url_for('notes.add_note')}}">Add notes.</a>
</div>
{% else %}
{% for note in private_notes %}
<div class="note-frame">
    <div class="note-date">
        <small>Added: {{note.timestamp.date()}} {{note.timestamp.time().isoformat(timespec='minutes')}}</small>
    </div>
    <div class="note-title">{{ note.title }}</div> 
    <span class="note-control">
                <button onClick="delete_note(this);" data-id="{{note.id}}"
                    class="delete btn btn-outline-danger btn-sm ">Delete</button>
                {% if note.attachment_hash %}
                <button onClick="delete_file(this);" data-id="{{note.id}}"
                    class="delete btn btn-outline-warning btn-sm ">Delete file</button>
                <a href="{{url_for('notes.download_file_private', file_hash = note.attachment_hash)}}"
                    class="btn btn-outline-info btn-sm">Download</a>
                {% else %}
                <input type="file" id="{{note.id}}" name="note" onchange="upload_file(this);"
                    style="display:none" />
                <button class="btn btn-outline-success btn-sm"
                    onclick="document.getElementById('{{note.id}}').click();">Upload</button>
                {% endif %}
                <a href="{{url_for('notes.edit_note', note_id = note.id)}}"
                    class="btn btn-outline-primary btn-sm">Edit</a>
                {% if note.is_public == False %}
                <a href="{{url_for('notes.make_public', note_id=note.id)}}"
                    class="btn btn-outline-secondary btn-sm ">Make public</a>
                {% else %}
                <a href="{{url_for('notes.make_private', note_id=note.id)}}"
                    class="btn btn-secondary btn-sm">Make
                    private</a>
                {% endif %}
    </span> 
</div>
{% endfor %}
{% endif %}

<script>
    const BASE_URL = 'https://localhost:5000/private-notes'


    function delete_note(data) {
        let item_id = data.getAttribute("data-id");
        fetch(BASE_URL + '/delete/' + item_id, {
            method: 'DELETE',
            credentials: 'include'
        })
            .then(response => response.json())
            .then(result => location.reload())
            .catch(err => console.log(err))
    }


    function delete_file(data) {
        let item_id = data.getAttribute("data-id");
        fetch(BASE_URL + '/files/delete/' + item_id, {
            method: 'DELETE',
            credentials: 'include'
        })
            .then(response => response.json())
            .then(result => location.reload())
            .catch(err => console.log(err))
    }

    function upload_file(data) {
        let fileData = new FormData();
        let file = data.files[0];
        let item_id = data.getAttribute("id");
        fileData.append("Note", file)
        console.log(item_id);
        console.log(file);
        fetch(BASE_URL + '/files/' + item_id, {
            method: 'PATCH',
            credentials: 'include',
            body: fileData
        })
            .then(response => response.json())
            .then(data => location.reload())
            .catch(err => console.log(err))
    }



</script>

{% endblock %}